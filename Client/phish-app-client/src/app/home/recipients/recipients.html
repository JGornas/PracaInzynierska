<div class="recipients-container">
  <header class="toolbar">
    <div class="left">
      <h2>Grupa odbiorców</h2>
      <div class="group-name">
        <label>Nazwa grupy</label>
        <input [(ngModel)]="selectedGroupName" class="form-control" placeholder="Wprowadź nazwę" />
      </div>
    </div>
    <div class="right">
      <button class="btn btn-secondary" (click)="showCsvImport = !showCsvImport">
        {{ showCsvImport ? 'Zamknij import' : 'Import CSV' }}
      </button>
      <button class="btn btn-primary" (click)="toggleAddMember()">Dodaj odbiorcę</button>
    </div>
  </header>

  <div class="subtoolbar">
    <div class="search">
      <input class="form-control" [(ngModel)]="search" placeholder="Szukaj po imieniu, nazwisku, emailu..." />
    </div>
    <div class="spacer"></div>
    <button class="btn btn-outline" (click)="assignGroupToCampaign()">Przypisz grupę do kampanii</button>
  </div>

  @if (showAddMember) {
    <div class="modal-backdrop" (click)="toggleAddMember()"></div>
    <div class="modal-dialog" role="dialog" aria-modal="true">
      <div class="modal-header">
        <h3>Dodaj odbiorcę</h3>
        <button class="close" (click)="toggleAddMember()">×</button>
      </div>
      <div class="modal-body">
        <form [formGroup]="memberForm" (ngSubmit)="addMemberFromForm()" class="member-form">
          <label>
            Imię
            <input class="form-control" formControlName="firstName" />
          </label>
          <label>
            Nazwisko
            <input class="form-control" formControlName="lastName" />
          </label>
          <label>
            E-mail *
            <input class="form-control" formControlName="email" />
            @if (memberForm.get('email')?.invalid && memberForm.get('email')?.touched) {
              <div class="error">Niepoprawny adres e-mail</div>
            }
          </label>
          <label>
            Stanowisko
            <input class="form-control" formControlName="position" />
          </label>
          <div class="modal-actions">
            <button class="btn btn-primary" type="submit" [disabled]="memberForm.invalid">Zapisz</button>
            <button class="btn" type="button" (click)="toggleAddMember()">Anuluj</button>
          </div>
        </form>
      </div>
    </div>
  }

  @if (showCsvImport) {
    <section class="card">
      <h3>Import CSV</h3>

      <div class="import-controls">
        <label>
          Delimiter:
          <select (change)="onDelimiterChange($event)">
            <option value=",">Przecinek (,)</option>
            <option value=";">Średnik (;)</option>
          </select>
        </label>

        <input type="file" accept=".csv,text/csv" (change)="onFileSelected($event)" />
        @if (csvFileName) {
          <span class="filename">{{ csvFileName }}</span>
        }

        <label class="checkbox">
          <input type="checkbox" [(ngModel)]="dryRun" name="dryRun" />
          Tylko dry-run (nie zapisuj)
        </label>
      </div>

      @if (csvPreview) {
        <div class="csv-preview">
          <h4>Podgląd i mapowanie</h4>

          <div class="mapping">
            @for (field of mappingFields; track field) {
              <label>
                {{ field }}
                <select (change)="onMappingChange(field, $event)">
                  <option value="">-- nie mapuj --</option>
                  @for (h of csvPreview.headers; track h) {
                    <option [value]="csvPreview.headers.indexOf(h)">
                      {{ csvPreview.headers.indexOf(h) }}: {{ h }}
                    </option>
                  }
                </select>
              </label>
            }
          </div>

          <table class="table table-sm preview-table">
            <thead>
              <tr>
                <th>#</th>
                @for (h of csvPreview.headers; track h) {
                  <th>{{ h }}</th>
                }
              </tr>
            </thead>
            <tbody>
              @for (r of csvPreview.rows; track r) {
                <tr>
                  <td>{{ csvPreview.rows.indexOf(r) + 1 }}</td>
                  @for (c of r; track c) {
                    <td>{{ c }}</td>
                  }
                </tr>
              }
            </tbody>
          </table>

          <div class="import-actions">
            <button class="btn" (click)="performImport(false)">Analizuj (dry run)</button>
            <button class="btn btn-primary" (click)="performImport(true)" [disabled]="dryRun">Importuj i zapisz</button>
          </div>
        </div>
      }

      @if (importReport) {
        <div class="import-report">
          <h4>Raport importu</h4>
          <p>
            Wierszy: {{ importReport.total }} |
            Poprawnych: {{ importReport.valid }} |
            Błędnych: {{ importReport.invalid }}
          </p>

          @if (importReport.errors.length > 0) {
            <div class="errors">
              <h5>Błędy</h5>
              <table class="table table-sm">
                <thead>
                  <tr><th>#</th><th>E-mail</th><th>Błąd</th></tr>
                </thead>
                <tbody>
                  @for (e of importReport.errors; track e) {
                    <tr>
                      <td>{{ importReport.errors.indexOf(e) + 1 }}</td>
                      <td>{{ e.email }}</td>
                      <td>{{ e.importError }}</td>
                    </tr>
                  }
                </tbody>
              </table>
            </div>
          }
        </div>
      }
    </section>
  }

  <section class="card members-list">
    <h3>Członkowie grupy ({{ filteredMembers.length }})</h3>

    @if (filteredMembers.length > 0) {
      <table class="table table-striped members-table">
        <thead>
          <tr><th>Imię</th><th>Nazwisko</th><th>E-mail</th><th>Stanowisko</th><th>Akcje</th></tr>
        </thead>
        <tbody>
          @for (m of filteredMembers; track m) {
            <tr>
              <td>{{ m.firstName }}</td>
              <td>{{ m.lastName }}</td>
              <td>{{ m.email }}</td>
              <td>{{ m.position }}</td>
              <td><button class="btn btn-danger btn-sm" (click)="removeMember(m.id)">Usuń</button></td>
            </tr>
          }
        </tbody>
      </table>
    } @else {
      <div class="empty">Brak członków w grupie — dodaj ręcznie lub zaimportuj CSV.</div>
    }
  </section>
</div>

